name: CI/CD Laravel Server
on:
  push: 
    branches: [main]
  pull_request:
    branches: [main]
jobs: 
  ci:
    runs-on: ubuntu-latest 
    steps:
      - name: Checkout code 
        uses: actions/checkout@v6.0.1
      - name: Install PHP
        uses: shivammathur/setup-php@2.36.0
        with: 
          php-version: 8.4.1
      - name: Install Composer
        run: |
            composer self-update 2.8.3
            composer install --no-interaction --no-progress --optimize-autoloader
      - name: Prepare Laravel 
        run: |
            cp .env.example .env
            php artisan key:generate
            php artisan config:cache
            php artisan config:clear
        
      - name: Run Tests
        run: php artisan test 
  cd: 
     runs-on: ubuntu-latest
     needs: ci
     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
     
     steps:
      - name: Checkout code 
        uses: actions/checkout@v6.0.1
      
      - name: Deploy to EC2 Server
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            cd /var/www/ServerSide-Ats
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            git remote set-url origin git@github.com:Omarmhmdd/ServerSide-Ats.git
            git pull origin main
            composer install --no-dev --optimize-autoloader --no-interaction
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            php artisan migrate --force
            php artisan config:cache
  php artisan route:cache
  php artisan view:cachecache
